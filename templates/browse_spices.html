{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-end justify-content-between gap-3 flex-wrap">
    <div>
      <h2 class="mb-1">Browse Spices</h2>
      <p class="text-muted mb-0">Search by spice name (live search supported).</p>
    </div>
    <div class="text-muted">
      Total: <b>{{ total }}</b>
    </div>
  </div>

  <!-- Live search -->
  <div class="mt-3">
    <input id="spiceSearch" class="form-control" placeholder="Type spice name..." value="{{ q }}" />
    <div id="liveResults" class="list-group mt-2" style="display:none;"></div>
  </div>

  <!-- Sort + per_page -->
  <form id="spiceControls" class="mt-3 d-flex flex-wrap gap-3 align-items-center" method="get" action="{{ url_for('browse_spices') }}">
    <input type="hidden" name="q" value="{{ q }}"/>

    <!-- Sort -->
    <div class="d-flex align-items-center gap-2">
      <label class="text-muted small mb-0" for="sortBy">Sort:</label>
      <select class="form-select form-select-sm" name="sort" id="sortBy" style="width:auto;"
              onchange="document.getElementById('spiceControls').submit()">
        <option value="name_asc" {% if sort=='name_asc' %}selected{% endif %}>Name (A–Z)</option>
        <option value="name_desc" {% if sort=='name_desc' %}selected{% endif %}>Name (Z–A)</option>
      </select>
    </div>

    <!-- Per page -->
    <div class="d-flex align-items-center gap-2">
      <label class="text-muted small mb-0" for="perPage">Per page:</label>
      <select class="form-select form-select-sm" name="per_page" id="perPage" style="width:auto;"
              onchange="document.getElementById('spiceControls').submit()">
        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
        <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
      </select>
    </div>

    <button class="btn btn-sm btn-primary" type="submit">Apply</button>
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('browse_spices') }}">Reset</a>
  </form>

  <!-- A–Z quick jump (visual only) -->
  <div class="mt-3 d-flex flex-wrap gap-2">
    {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('browse_spices', starts=letter, sort=sort, per_page=per_page) }}"
         title="Show spices containing '{{ letter }}'">
        {{ letter }}
      </a>
    {% endfor %}
  </div>

  <!-- Table -->
  <div class="mt-4">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Spice</th>
          <th>Botanical name</th>
          <th class="text-end">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for s in spices %}
        <tr>
          <td><b>{{ s.spice_name }}</b></td>
          <td>{{ s.botanical_name or "—" }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('spice_detail', spice_id=s.spice_id) }}">Open</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% include 'pagination.html' %}

</div>

<script>
  const input = document.getElementById('spiceSearch');
  const list = document.getElementById('liveResults');
  let timer = null;

  function hideList(){ list.style.display='none'; list.innerHTML=''; }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    clearTimeout(timer);
    if (!q){ hideList(); return; }
    timer = setTimeout(async () => {
      const res = await fetch(`/api/search/spices?q=${encodeURIComponent(q)}&limit=15`);
      const data = await res.json();
      if (!data.length){ hideList(); return; }
      list.innerHTML = data.map(x => (
        `<a href="/spice/${x.spice_id}" class="list-group-item list-group-item-action">`+
        `<div class="d-flex justify-content-between">`+
        `<span><b>${x.spice_name}</b></span>`+
        `<small class="text-muted">${x.botanical_name || ''}</small>`+
        `</div></a>`
      )).join('');
      list.style.display='block';
    }, 200);
  });

  document.addEventListener('click', (e)=>{
    if (!list.contains(e.target) && e.target !== input) hideList();
  });
</script>
{% endblock %}
