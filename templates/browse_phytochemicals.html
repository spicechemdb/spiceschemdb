{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-end justify-content-between gap-3 flex-wrap">
    <div>
      <h2 class="mb-1">Browse Phytochemicals</h2>
      <p class="text-muted mb-0">Search by phytochemical name or PubChem CID. Use filters to narrow results.</p>
    </div>
    <div class="text-muted">
      Total: <b>{{ total }}</b>
    </div>
  </div>

  <div class="mt-3">
    <input id="phytoSearch" class="form-control" placeholder="Type phytochemical name or CID..." value="{{ q }}" />
    <div id="livePhytoResults" class="list-group mt-2" style="display:none;"></div>
  </div>

    <form id="filterForm" class="mt-3 d-flex flex-wrap gap-3 align-items-center" method="get" action="{{ url_for('browse_phytochemicals') }}">
    <input type="hidden" name="q" value="{{ q }}" />
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="only_cid" value="1" id="onlyCid" {% if only_cid %}checked{% endif %}>
      <label class="form-check-label" for="onlyCid">Only with CID</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="only_3d" value="1" id="only3d" {% if only_3d %}checked{% endif %}>
      <label class="form-check-label" for="only3d">Only 3D available</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="only_2d" value="1" id="only2d" {% if only_2d %}checked{% endif %}>
      <label class="form-check-label" for="only2d">Only 2D available</label>
    </div>
    <button class="btn btn-sm btn-primary" type="submit">Apply</button>
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('browse_phytochemicals') }}">Reset</a>
  </form>

  <div class="mt-4">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Phytochemical</th>
          <th>CID</th>
          <th>2D</th>
          <th>3D</th>
          <th class="text-end">Found in</th>
        </tr>
      </thead>
      <tbody>
        {% for p in phytochemicals %}
        <tr>
          <td>
            <a href="{{ url_for('phytochemical_detail', phyto_id=p.phyto_id) }}"><b>{{ p.phyto_name }}</b></a>
          </td>
          <td>{{ p.cid if p.cid else "—" }}</td>
          <td>{% if p.has_2d or p.has_3d %}✅{% else %}—{% endif %}</td>
	  <td>{% if p.has_3d %}✅{% else %}—{% endif %}</td>
          <td class="text-end">{{ p.spice_count }} spices</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% include 'pagination.html' %}

</div>

<script>
  const input = document.getElementById('phytoSearch');
  const list = document.getElementById('livePhytoResults');
  let timer = null;

  function hideList(){ list.style.display='none'; list.innerHTML=''; }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    clearTimeout(timer);
    if (!q){ hideList(); return; }
    timer = setTimeout(async () => {
      const res = await fetch(`/api/search/phytochemicals?q=${encodeURIComponent(q)}&limit=15`);
      const data = await res.json();
      if (!data.length){ hideList(); return; }
      list.innerHTML = data.map(x => (
        `<a href="/phytochemical/${x.phyto_id}" class="list-group-item list-group-item-action">`+
        `<div class="d-flex justify-content-between">`+
        `<span><b>${x.phyto_name}</b></span>`+
        `<small class="text-muted">CID: ${x.cid || '—'} | 2D: ${x.has_2d ? 'yes' : 'no'} | 3D: ${x.has_3d ? 'yes' : 'no'}</small>`+
        `</div></a>`
      )).join('');
      list.style.display='block';
    }, 200);
  });

  document.addEventListener('click', (e)=>{
    if (!list.contains(e.target) && e.target !== input) hideList();
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const only2d = document.getElementById("only2d");
  const only3d = document.getElementById("only3d");
  const form = document.getElementById("filterForm");

  console.log("only2d:", only2d, "only3d:", only3d, "form:", form);

  if (!only2d || !only3d || !form) return;

  only2d.addEventListener("change", function () {
    if (only2d.checked) only3d.checked = false;
    form.submit();
  });

  only3d.addEventListener("change", function () {
    if (only3d.checked) only2d.checked = false;
    form.submit();
  });
});
</script>


{% endblock %}
